<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DG-LAB MCP æµ‹è¯•å·¥å…·</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', sans-serif; background: #1e1e2e; color: #cdd6f4; min-height: 100vh; }
    .app { display: flex; height: 100vh; }
    .sidebar { width: 280px; background: #181825; border-right: 1px solid #313244; display: flex; flex-direction: column; }
    .sidebar-header { padding: 15px; border-bottom: 1px solid #313244; }
    .sidebar-header h2 { color: #89b4fa; font-size: 14px; margin-bottom: 10px; }
    .conn-status { display: flex; align-items: center; gap: 8px; font-size: 12px; }
    .conn-dot { width: 8px; height: 8px; border-radius: 50%; background: #f38ba8; }
    .conn-dot.connected { background: #a6e3a1; }
    .conn-btns { display: flex; gap: 5px; margin-top: 10px; }
    .conn-btns button { flex: 1; padding: 6px; font-size: 11px; border: none; border-radius: 4px; cursor: pointer; }
    .btn-connect { background: #89b4fa; color: #1e1e2e; }
    .btn-disconnect { background: #f38ba8; color: #1e1e2e; }
    .btn-connect:disabled, .btn-disconnect:disabled { opacity: 0.5; cursor: not-allowed; }
    .tool-list { flex: 1; overflow-y: auto; padding: 10px; }
    .tool-group { margin-bottom: 15px; }
    .tool-group-title { font-size: 11px; color: #6c7086; text-transform: uppercase; margin-bottom: 5px; padding: 0 5px; }
    .tool-item { padding: 8px 10px; border-radius: 4px; cursor: pointer; font-size: 13px; margin-bottom: 2px; transition: background 0.15s; }
    .tool-item:hover { background: #313244; }
    .tool-item.active { background: #45475a; color: #89b4fa; }
    .main { flex: 1; display: flex; flex-direction: column; }
    .toolbar { padding: 10px 15px; background: #181825; border-bottom: 1px solid #313244; display: flex; align-items: center; gap: 10px; }
    .tool-name { font-size: 16px; font-weight: bold; color: #cba6f7; }
    .btn-send { background: #a6e3a1; color: #1e1e2e; border: none; padding: 8px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; margin-left: auto; }
    .btn-send:hover { background: #94e2d5; }
    .btn-send:disabled { opacity: 0.5; cursor: not-allowed; }
    .content { flex: 1; display: flex; overflow: hidden; }
    .params-panel { width: 50%; border-right: 1px solid #313244; display: flex; flex-direction: column; }
    .response-panel { width: 50%; display: flex; flex-direction: column; }
    .panel-header { padding: 10px 15px; background: #11111b; font-size: 12px; color: #6c7086; text-transform: uppercase; border-bottom: 1px solid #313244; }
    .panel-content { flex: 1; overflow-y: auto; padding: 15px; }
    .param-item { margin-bottom: 15px; }
    .param-label { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }
    .param-name { font-weight: bold; color: #89b4fa; }
    .param-required { color: #f38ba8; font-size: 10px; }
    .param-optional { color: #6c7086; font-size: 10px; }
    .param-type { color: #6c7086; font-size: 11px; margin-left: auto; }
    .param-desc { font-size: 11px; color: #6c7086; margin-bottom: 5px; }
    .param-input { width: 100%; background: #11111b; border: 1px solid #313244; color: #cdd6f4; padding: 8px 10px; border-radius: 4px; font-family: 'Consolas', monospace; font-size: 13px; }
    .param-input:focus { outline: none; border-color: #89b4fa; }
    .param-input.textarea { min-height: 80px; resize: vertical; }
    select.param-input { cursor: pointer; }
    .response-content { background: #11111b; border-radius: 4px; padding: 15px; font-family: 'Consolas', monospace; font-size: 12px; white-space: pre-wrap; word-break: break-all; min-height: 200px; }
    .json-key { color: #89b4fa; }
    .json-string { color: #a6e3a1; }
    .json-number { color: #fab387; }
    .json-boolean { color: #cba6f7; }
    .json-null { color: #6c7086; }
    .log-entry { margin-bottom: 10px; padding: 10px; border-radius: 4px; }
    .log-entry.send { background: #1e3a2e; border-left: 3px solid #a6e3a1; }
    .log-entry.receive { background: #2e1e3a; border-left: 3px solid #cba6f7; }
    .log-entry.error { background: #3a1e1e; border-left: 3px solid #f38ba8; }
    .log-entry.event { background: #1e2e3a; border-left: 3px solid #89b4fa; }
    .log-time { font-size: 10px; color: #6c7086; margin-bottom: 5px; }
    .log-label { font-size: 11px; font-weight: bold; margin-bottom: 5px; }
    .log-label.send { color: #a6e3a1; }
    .log-label.receive { color: #cba6f7; }
    .log-label.error { color: #f38ba8; }
    .log-label.event { color: #89b4fa; }
    .empty-state { color: #6c7086; text-align: center; padding: 40px; }
    .mcp-btns { display: flex; gap: 5px; margin-top: 10px; flex-wrap: wrap; }
    .mcp-btns button { padding: 4px 8px; font-size: 10px; background: #45475a; color: #cdd6f4; border: none; border-radius: 3px; cursor: pointer; }
    .mcp-btns button:hover { background: #585b70; }
    .clear-btn { background: #45475a !important; color: #cdd6f4 !important; font-size: 11px !important; padding: 5px 10px !important; }
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>ğŸ”Œ DG-LAB MCP</h2>
        <div class="conn-status">
          <div id="connDot" class="conn-dot"></div>
          <span id="connText">æœªè¿æ¥</span>
        </div>
        <div class="conn-btns">
          <button id="btnConnect" class="btn-connect" onclick="connect()">è¿æ¥</button>
          <button id="btnDisconnect" class="btn-disconnect" onclick="disconnect()" disabled>æ–­å¼€</button>
        </div>
        <div class="mcp-btns">
          <button onclick="sendInitialize()">Initialize</button>
          <button onclick="loadTools()">åˆ·æ–°å·¥å…·</button>
          <button onclick="sendPing()">Ping</button>
        </div>
      </div>
      <div class="tool-list" id="toolList">
        <div class="empty-state">è¿æ¥åç‚¹å‡»"åˆ·æ–°å·¥å…·"åŠ è½½</div>
      </div>
    </div>
    <div class="main">
      <div class="toolbar">
        <span class="tool-name" id="currentToolName">é€‰æ‹©ä¸€ä¸ªå·¥å…·</span>
        <button class="btn-send" id="btnSend" onclick="sendToolCall()" disabled>å‘é€è¯·æ±‚</button>
      </div>
      <div class="content">
        <div class="params-panel">
          <div class="panel-header">å‚æ•°</div>
          <div class="panel-content" id="paramsContainer">
            <div class="empty-state">ä»å·¦ä¾§é€‰æ‹©å·¥å…·</div>
          </div>
        </div>
        <div class="response-panel">
          <div class="panel-header">
            å“åº”æ—¥å¿—
            <button class="clear-btn" onclick="clearLogs()" style="float:right;">æ¸…ç©º</button>
          </div>
          <div class="panel-content" id="responseContainer"></div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>

<script>
let eventSource = null;
let sessionId = null;
let requestId = 1;
let tools = [];
let currentTool = null;
const pendingRequests = new Map(); // ç­‰å¾… SSE å“åº”çš„è¯·æ±‚

// è¿æ¥ç®¡ç†
function connect() {
  if (eventSource) eventSource.close();
  updateConnStatus('waiting', 'è¿æ¥ä¸­...');
  eventSource = new EventSource('http://localhost:3323/sse');
  eventSource.onopen = () => addLog('SSE è¿æ¥å·²å»ºç«‹', 'event');
  eventSource.addEventListener('endpoint', (e) => {
    addLog(`æ”¶åˆ° endpoint: ${e.data}`, 'event');
    const match = e.data.match(/sessionId=([^&]+)/);
    if (match) {
      sessionId = match[1];
      updateConnStatus('connected', `å·²è¿æ¥: ${sessionId.slice(0,8)}...`);
      document.getElementById('btnConnect').disabled = true;
      document.getElementById('btnDisconnect').disabled = false;
    }
  });
  eventSource.addEventListener('message', (e) => {
    try {
      const data = JSON.parse(e.data);
      // æ£€æŸ¥æ˜¯å¦æœ‰ç­‰å¾…è¿™ä¸ªå“åº”çš„è¯·æ±‚
      if (data.id !== undefined && pendingRequests.has(data.id)) {
        const resolve = pendingRequests.get(data.id);
        pendingRequests.delete(data.id);
        resolve(data);
      }
      addLog(formatResponse(data), 'receive', 'SSE å“åº”');
    } catch {
      addLog(e.data, 'receive', 'SSE æ¶ˆæ¯');
    }
  });
  eventSource.onerror = () => {
    addLog('SSE è¿æ¥é”™è¯¯', 'error');
    updateConnStatus('disconnected', 'è¿æ¥é”™è¯¯');
    document.getElementById('btnConnect').disabled = false;
    document.getElementById('btnDisconnect').disabled = true;
  };
}

function disconnect() {
  if (eventSource) { eventSource.close(); eventSource = null; }
  sessionId = null;
  pendingRequests.clear();
  updateConnStatus('disconnected', 'å·²æ–­å¼€');
  document.getElementById('btnConnect').disabled = false;
  document.getElementById('btnDisconnect').disabled = true;
  addLog('å·²æ–­å¼€è¿æ¥', 'event');
}

function updateConnStatus(status, text) {
  const dot = document.getElementById('connDot');
  const txt = document.getElementById('connText');
  dot.className = 'conn-dot' + (status === 'connected' ? ' connected' : '');
  txt.textContent = text;
}

// è¯·æ±‚å‘é€ - ç­‰å¾… SSE å“åº”
async function sendRequest(request) {
  if (!sessionId) { addLog('é”™è¯¯: æœªè¿æ¥', 'error'); return null; }
  const url = `http://localhost:3323/message?sessionId=${sessionId}`;
  const reqId = request.id;
  addLog(JSON.stringify(request, null, 2), 'send', 'å‘é€è¯·æ±‚');
  
  // åˆ›å»ºç­‰å¾… SSE å“åº”çš„ Promise
  const responsePromise = new Promise((resolve) => {
    pendingRequests.set(reqId, resolve);
    // è¶…æ—¶ 10 ç§’
    setTimeout(() => {
      if (pendingRequests.has(reqId)) {
        pendingRequests.delete(reqId);
        addLog(`è¯·æ±‚ ${reqId} è¶…æ—¶`, 'error');
        resolve(null);
      }
    }, 10000);
  });
  
  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(request)
    });
    if (!response.ok) {
      addLog(`HTTP é”™è¯¯: ${response.status}`, 'error');
      pendingRequests.delete(reqId);
      return null;
    }
    // ç­‰å¾… SSE å“åº”
    return await responsePromise;
  } catch (err) {
    addLog(`å‘é€å¤±è´¥: ${err.message}`, 'error');
    pendingRequests.delete(reqId);
    return null;
  }
}

// æ ¼å¼åŒ–å“åº” - è§£æ text å†…å®¹ä¸­çš„ JSON
function formatResponse(obj) {
  if (!obj) return 'null';
  // æ·±æ‹·è´å¤„ç†
  const processed = JSON.parse(JSON.stringify(obj));
  // å¤„ç† tool call å“åº”ä¸­çš„ content
  if (processed.result && processed.result.content) {
    processed.result.content = processed.result.content.map(item => {
      if (item.type === 'text' && typeof item.text === 'string') {
        try {
          item.text = JSON.parse(item.text);
          item._parsed = true;
        } catch {}
      }
      return item;
    });
  }
  return syntaxHighlight(JSON.stringify(processed, null, 2));
}

// JSON è¯­æ³•é«˜äº®
function syntaxHighlight(json) {
  return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, (match) => {
    let cls = 'json-number';
    if (/^"/.test(match)) {
      cls = /:$/.test(match) ? 'json-key' : 'json-string';
    } else if (/true|false/.test(match)) {
      cls = 'json-boolean';
    } else if (/null/.test(match)) {
      cls = 'json-null';
    }
    return `<span class="${cls}">${match}</span>`;
  });
}

// æ—¥å¿—ç®¡ç†
function addLog(content, type, label = '') {
  const container = document.getElementById('responseContainer');
  const entry = document.createElement('div');
  entry.className = `log-entry ${type}`;
  const time = new Date().toLocaleTimeString();
  entry.innerHTML = `
    <div class="log-time">${time}</div>
    ${label ? `<div class="log-label ${type}">${label}</div>` : ''}
    <div class="response-content">${content}</div>
  `;
  container.appendChild(entry);
  container.scrollTop = container.scrollHeight;
}

function clearLogs() {
  document.getElementById('responseContainer').innerHTML = '';
}

// MCP åè®®
function sendInitialize() {
  sendRequest({
    jsonrpc: '2.0', id: requestId++, method: 'initialize',
    params: { protocolVersion: '2024-11-05', capabilities: {}, clientInfo: { name: 'test-client', version: '1.0.0' } }
  });
}

function sendPing() {
  sendRequest({ jsonrpc: '2.0', id: requestId++, method: 'ping' });
}

// åŠ è½½å·¥å…·åˆ—è¡¨
async function loadTools() {
  const result = await sendRequest({ jsonrpc: '2.0', id: requestId++, method: 'tools/list' });
  console.log('tools/list result:', result);
  if (result && result.result && result.result.tools) {
    tools = result.result.tools;
    renderToolList();
    addLog(`å·²åŠ è½½ ${tools.length} ä¸ªå·¥å…·`, 'event');
  } else {
    addLog('åŠ è½½å·¥å…·å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿”å›æ•°æ®: ' + JSON.stringify(result), 'error');
  }
}

function renderToolList() {
  const container = document.getElementById('toolList');
  if (tools.length === 0) {
    container.innerHTML = '<div class="empty-state">æ²¡æœ‰å¯ç”¨å·¥å…·</div>';
    return;
  }
  // æŒ‰å‰ç¼€åˆ†ç»„
  const groups = {};
  tools.forEach(tool => {
    const prefix = tool.name.split('_')[0] || 'other';
    if (!groups[prefix]) groups[prefix] = [];
    groups[prefix].push(tool);
  });
  let html = '';
  for (const [group, items] of Object.entries(groups)) {
    html += `<div class="tool-group"><div class="tool-group-title">${group}</div>`;
    items.forEach(tool => {
      html += `<div class="tool-item" data-name="${tool.name}" onclick="selectTool('${tool.name}')">${tool.name}</div>`;
    });
    html += '</div>';
  }
  container.innerHTML = html;
}

// é€‰æ‹©å·¥å…·
function selectTool(name) {
  currentTool = tools.find(t => t.name === name);
  if (!currentTool) return;
  // æ›´æ–° UI
  document.querySelectorAll('.tool-item').forEach(el => el.classList.remove('active'));
  document.querySelector(`.tool-item[data-name="${name}"]`)?.classList.add('active');
  document.getElementById('currentToolName').textContent = name;
  document.getElementById('btnSend').disabled = false;
  renderParams();
}

// æ¸²æŸ“å‚æ•°è¡¨å•
function renderParams() {
  const container = document.getElementById('paramsContainer');
  if (!currentTool || !currentTool.inputSchema) {
    container.innerHTML = '<div class="empty-state">è¯¥å·¥å…·æ— å‚æ•°</div>';
    return;
  }
  const schema = currentTool.inputSchema;
  const props = schema.properties || {};
  const required = schema.required || [];
  if (Object.keys(props).length === 0) {
    container.innerHTML = '<div class="empty-state">è¯¥å·¥å…·æ— å‚æ•°</div>';
    return;
  }
  let html = `<div style="margin-bottom:15px;color:#6c7086;font-size:12px;">${currentTool.description || ''}</div>`;
  for (const [name, prop] of Object.entries(props)) {
    const isRequired = required.includes(name);
    const type = prop.type || 'string';
    const enumVals = prop.enum;
    html += `<div class="param-item">
      <div class="param-label">
        <span class="param-name">${name}</span>
        <span class="${isRequired ? 'param-required' : 'param-optional'}">${isRequired ? '*å¿…å¡«' : 'å¯é€‰'}</span>
        <span class="param-type">${type}</span>
      </div>
      ${prop.description ? `<div class="param-desc">${prop.description}</div>` : ''}`;
    if (enumVals) {
      html += `<select class="param-input" data-param="${name}" data-type="${type}">
        <option value="">-- é€‰æ‹© --</option>
        ${enumVals.map(v => `<option value="${v}">${v}</option>`).join('')}
      </select>`;
    } else if (type === 'array' || type === 'object') {
      html += `<textarea class="param-input textarea" data-param="${name}" data-type="${type}" placeholder='JSON æ ¼å¼'></textarea>`;
    } else if (type === 'boolean') {
      html += `<select class="param-input" data-param="${name}" data-type="boolean">
        <option value="">-- é€‰æ‹© --</option>
        <option value="true">true</option>
        <option value="false">false</option>
      </select>`;
    } else if (type === 'integer' || type === 'number') {
      html += `<input type="number" class="param-input" data-param="${name}" data-type="${type}" placeholder="${prop.default !== undefined ? 'é»˜è®¤: ' + prop.default : ''}">`;
    } else {
      html += `<input type="text" class="param-input" data-param="${name}" data-type="${type}" placeholder="${prop.default !== undefined ? 'é»˜è®¤: ' + prop.default : ''}">`;
    }
    html += '</div>';
  }
  container.innerHTML = html;
}

// å‘é€å·¥å…·è°ƒç”¨
function sendToolCall() {
  if (!currentTool) return;
  const args = {};
  document.querySelectorAll('#paramsContainer .param-input').forEach(el => {
    const name = el.dataset.param;
    const type = el.dataset.type;
    let value = el.value.trim();
    if (!value) return;
    if (type === 'integer') {
      args[name] = parseInt(value);
    } else if (type === 'number') {
      args[name] = parseFloat(value);
    } else if (type === 'boolean') {
      args[name] = value === 'true';
    } else if (type === 'array' || type === 'object') {
      try { args[name] = JSON.parse(value); } catch { args[name] = value; }
    } else {
      args[name] = value;
    }
  });
  sendRequest({
    jsonrpc: '2.0',
    id: requestId++,
    method: 'tools/call',
    params: { name: currentTool.name, arguments: args }
  });
}
</script>